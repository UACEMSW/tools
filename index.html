<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>EMS4 | Admin Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        .deploy-card { transition: all 0.2s ease; border-left: 5px solid #e2e8f0; }
        .plat-btn.active { border-color: #2563eb; background-color: #eff6ff; color: #2563eb; ring: 4px; ring-color: #eff6ff; }
        #loadingOverlay, #loginOverlay { background: rgba(255,255,255,0.95); position: fixed; inset: 0; z-index: 200; align-items: center; justify-content: center; display: flex; }
        #loadingOverlay { display: none; z-index: 210; }
        .viewer-mode .admin-only { display: none !important; }
        .viewer-mode .platform-selector { display: none !important; }
        .viewer-mode input, .viewer-mode select, .viewer-mode textarea { pointer-events: none !important; background-color: #f8fafc; border-color: #e2e8f0; }
        .log-item { border-left: 3px solid #3b82f6; font-family: monospace; }
    </style>
</head>
<body class="bg-slate-100 p-4 md:p-8 font-sans text-slate-900">

    <div id="loginOverlay" style="display: none;">
        <div class="bg-white p-8 rounded-3xl shadow-2xl border border-slate-200 w-full max-w-sm text-center">
            <h2 class="text-2xl font-black italic mb-6 uppercase tracking-tighter text-blue-600">ADMIN ACCESS</h2>
            <input type="password" id="accessKey" placeholder="Enter Admin Key..." class="w-full p-4 border-2 rounded-2xl mb-4 text-center font-bold outline-none">
            <button onclick="checkAccess()" class="w-full bg-blue-600 text-white p-4 rounded-2xl font-black uppercase hover:bg-blue-700 transition">Login</button>
        </div>
    </div>
    
    <div id="loadingOverlay"><div class="animate-spin rounded-full h-12 w-12 border-t-4 border-blue-600"></div></div>

    <div id="appContent" class="hidden max-w-5xl mx-auto">
        <header class="bg-white p-6 rounded-2xl shadow-sm border-b-4 border-blue-600 mb-6 flex justify-between items-center">
            <h1 class="text-2xl font-black italic uppercase tracking-tighter">EMS4 PLAN</h1>
            <div class="flex gap-4 items-center">
                <div id="limitContainer" class="hidden bg-blue-50 px-4 py-2 rounded-xl border border-blue-100">
                    <label class="block text-[8px] font-black text-blue-400 uppercase">Seeds Per Hour</label>
                    <input type="number" id="globalLimit" oninput="updateLimitUI(); checkIfChanged();" class="w-16 bg-transparent font-black text-blue-700 outline-none text-lg" value="100">
                </div>
                <span id="roleBadge" class="text-white px-2 py-0.5 rounded text-[8px] font-black uppercase">---</span>
                <button onclick="logout()" class="admin-only text-[10px] text-red-500 font-bold underline">Logout</button>
            </div>
        </header>

        <div class="platform-selector grid grid-cols-3 gap-4 mb-6">
            <button onclick="changePlat('WEB', 100)" id="btn-WEB" class="plat-btn bg-white p-4 rounded-xl shadow-sm border-2 border-transparent font-black text-slate-600 uppercase italic">Web</button>
            <button onclick="changePlat('SELENIUM', 75)" id="btn-SELENIUM" class="plat-btn bg-white p-4 rounded-xl shadow-sm border-2 border-transparent font-black text-slate-600 uppercase italic">Selenium</button>
            <button onclick="changePlat('AUTOMAT', 20)" id="btn-AUTOMAT" class="plat-btn bg-white p-4 rounded-xl shadow-sm border-2 border-transparent font-black text-slate-600 uppercase italic">Automat</button>
        </div>

        <div id="mainSection" class="hidden space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-xs font-black text-red-500 uppercase italic">üö´ SPAM ACTIONS</h3>
                        <div class="flex items-center gap-2">
                            <div class="bg-red-500 text-white px-2 py-1 rounded text-[10px] font-black uppercase">TOTAL: <span id="spam-calculated-total">0</span></div>
                            <button onclick="showActionMenu('spam')" class="admin-only w-6 h-6 bg-red-500 text-white rounded-full font-bold">+</button>
                        </div>
                    </div>
                    <div id="spam-actions-container" class="grid grid-cols-2 gap-3"></div>
                </div>

                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-xs font-black text-blue-500 uppercase italic">üì• INBOX ACTIONS</h3>
                        <div class="flex items-center gap-2">
                            <div class="bg-blue-600 text-white px-2 py-1 rounded text-[10px] font-black uppercase">TOTAL: <span id="inbox-calculated-total">0</span></div>
                            <button onclick="showActionMenu('inbox')" class="admin-only w-6 h-6 bg-blue-500 text-white rounded-full font-bold">+</button>
                        </div>
                    </div>
                    <div id="inbox-actions-container" class="grid grid-cols-2 gap-3"></div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-sm grid grid-cols-1 md:grid-cols-2 gap-6 border border-slate-200">
                <div>
                    <label class="block text-[10px] font-black text-slate-400 mb-1 uppercase tracking-widest">Deploys Count</label>
                    <input type="number" id="deployCount" oninput="checkIfChanged(); generateDeploys();" class="w-full p-2 border-2 rounded-lg font-black text-blue-600 text-lg text-center">
                </div>
                <div>
                    <label class="block text-[10px] font-black text-blue-500 mb-1 uppercase italic">üîë Filter (Code Mot)</label>
                    <input type="text" id="filterKeyword" oninput="checkIfChanged()" class="w-full p-2 border-2 border-blue-100 rounded-lg font-bold text-blue-700 bg-blue-50">
                </div>
            </div>

            <div id="deploysContainer" class="space-y-4"></div>

            <div class="admin-only sticky bottom-4 z-10">
                <button id="saveBtn" disabled onclick="processSave()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-5 rounded-2xl font-black text-xl shadow-2xl uppercase italic">Save & Notify</button>
            </div>

            <div class="admin-only bg-slate-900 p-6 rounded-2xl shadow-xl mt-12">
                <h3 class="text-white font-black uppercase text-sm mb-4 italic flex items-center gap-2">
                    <span class="text-blue-500">‚óè</span> Last Updates (10)
                </h3>
                <div id="historyLogs" class="space-y-3 max-h-96 overflow-y-auto pr-2"></div>
            </div>
        </div>
    </div>

    <div id="actionModal" class="fixed inset-0 bg-black/50 hidden z-[300] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-xs overflow-hidden">
            <div id="modalTitle" class="bg-slate-900 p-4 text-white font-black uppercase text-xs text-center">Add Action</div>
            <div id="modalList" class="p-2 grid grid-cols-1 gap-1 max-h-64 overflow-y-auto"></div>
            <button onclick="closeModal()" class="w-full p-4 bg-slate-100 font-black uppercase text-[10px]">Cancel</button>
        </div>
    </div>

    <script>
        const ADMIN_KEY = "admin75"; 
        const firebaseConfig = {
          apiKey: "AIzaSyAFR96bibEGLaMroqFZCLcSHyCoAdewz78",
          authDomain: "ems4-reporting.firebaseapp.com",
          databaseURL: "https://ems4-reporting-default-rtdb.firebaseio.com",
          projectId: "ems4-reporting"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const telegramToken = '8445418590:AAEzun8AqYrkmFnzMoXaz3UBIQRTQCgQHeI'; 
        const telegramChatId = '-5224398844';
        const netlifyBase = "https://ems4-plan.netlify.app";

        let userRole = "viewer";
        let currentPlatform = "";
        let oldCloudData = null;

        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const savedKey = localStorage.getItem('ems4_admin_key');
            if (urlParams.get('mode') === 'view') {
                userRole = "viewer";
                document.body.classList.add('viewer-mode');
                startApp();
                const plat = urlParams.get('plat') || 'WEB';
                selectPlatform(plat, 100);
            } else if (savedKey === ADMIN_KEY) {
                userRole = "admin";
                startApp();
            } else {
                document.getElementById('loginOverlay').style.display = 'flex';
            }
        };

        function checkAccess() {
            const input = document.getElementById('accessKey').value;
            if (input === ADMIN_KEY) {
                localStorage.setItem('ems4_admin_key', input);
                userRole = "admin";
                startApp();
            } else { alert("Wrong Key!"); }
        }

        function logout() { localStorage.removeItem('ems4_admin_key'); location.reload(); }

        function startApp() {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('appContent').classList.remove('hidden');
            document.getElementById('roleBadge').innerText = userRole.toUpperCase();
            document.getElementById('roleBadge').className = userRole === 'admin' ? "bg-red-600 text-white px-2 py-0.5 rounded text-[8px] font-black" : "bg-blue-600 text-white px-2 py-0.5 rounded text-[8px] font-black";
        }

        function calculateTotals() {
            ['spam', 'inbox'].forEach(type => {
                let sum = 0;
                document.querySelectorAll(`#${type}-actions-container input`).forEach(inp => { sum += parseInt(inp.value) || 0; });
                document.getElementById(`${type}-calculated-total`).innerText = sum;
            });
        }

        function addActionUI(type, name, value) {
            const container = document.getElementById(`${type}-actions-container`);
            if ([...container.querySelectorAll('label')].some(l => l.innerText === name)) return;
            const div = document.createElement('div');
            const color = type === 'spam' ? 'red' : 'blue';
            div.className = `bg-${color}-50 border-${color}-100 p-2 rounded-xl border relative action-chip`;
            div.innerHTML = `
                ${userRole === 'admin' ? `<button onclick="this.parentElement.remove(); calculateTotals(); checkIfChanged();" class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-4 h-4 text-[10px]">√ó</button>` : ''}
                <label class="block text-[8px] font-black text-${color}-400 uppercase">${name}</label>
                <input type="number" data-action="${name}" oninput="calculateTotals(); checkIfChanged()" class="w-full bg-transparent font-black text-${color}-700 text-lg outline-none" value="${value}">
            `;
            container.appendChild(div);
            calculateTotals();
        }

        async function selectPlatform(p, count) {
            currentPlatform = p;
            document.getElementById('loadingOverlay').style.display = 'flex';
            document.querySelectorAll('.plat-btn').forEach(b => b.classList.remove('active'));
            if(document.getElementById('btn-'+p)) document.getElementById('btn-'+p).classList.add('active');
            document.getElementById('mainSection').classList.remove('hidden');
            document.getElementById('limitContainer').classList.remove('hidden');

            const snap = await db.ref(`ems4/plans/${p}/current`).once('value');
            oldCloudData = snap.val() || { limit: count, filter: "", deploys: [], actions_list: [] };
            
            if(userRole === 'admin') loadHistory(p);

            document.getElementById('spam-actions-container').innerHTML = '';
            document.getElementById('inbox-actions-container').innerHTML = '';
            document.getElementById('globalLimit').value = oldCloudData.limit || count;
            document.getElementById('deployCount').value = oldCloudData.deploys ? oldCloudData.deploys.length : 8;
            document.getElementById('filterKeyword').value = oldCloudData.filter || "";
            if(oldCloudData.actions_list) oldCloudData.actions_list.forEach(a => addActionUI(a.type.toLowerCase(), a.name, a.value));
            
            generateDeploys(oldCloudData.deploys);
            calculateTotals();
            document.getElementById('saveBtn').disabled = true;
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        async function loadHistory(p) {
            const histSnap = await db.ref(`ems4/plans/${p}/history`).limitToLast(10).once('value');
            const container = document.getElementById('historyLogs');
            container.innerHTML = "";
            const logs = [];
            histSnap.forEach(s => { logs.unshift(s.val()); });
            logs.forEach(log => {
                container.innerHTML += `
                    <div class="log-item bg-slate-800/50 p-3 rounded-r-lg border-blue-500 mb-2">
                        <div class="flex justify-between text-[10px] mb-1"><span class="text-blue-400 font-bold">${log.timestamp}</span></div>
                        <div class="text-[11px] text-slate-200 leading-relaxed">${log.changeSummary.replace(/\n/g, '<br>')}</div>
                    </div>`;
            });
        }

        async function processSave() {
            const limit = parseInt(document.getElementById('globalLimit').value);
            const filter = document.getElementById('filterKeyword').value;
            const now = new Date();
            const timestamp = now.toLocaleDateString('en-GB', {day:'2-digit', month:'2-digit'}) + ", " + 
                              now.toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'});
            
            let actions = [];
            document.querySelectorAll('.action-chip').forEach(el => {
                actions.push({ 
                    type: el.closest('#spam-actions-container') ? 'SPAM' : 'INBOX',
                    name: el.querySelector('label').innerText,
                    value: parseInt(el.querySelector('input').value) || 0
                });
            });

            let deploys = [];
            let logDetails = [];

            // 1. Check Limit & Filter
            if(oldCloudData.limit != limit) logDetails.push(`‚Ä¢ SEEDS: ${oldCloudData.limit} -> ${limit}`);
            if(oldCloudData.filter != filter) logDetails.push(`‚Ä¢ FILTER: ${oldCloudData.filter || 'None'} -> ${filter}`);

            // 2. Check Actions (Detailed)
            actions.forEach(newAct => {
                const oldAct = (oldCloudData.actions_list || []).find(a => a.name === newAct.name && a.type === newAct.type);
                const oldVal = oldAct ? parseInt(oldAct.value) : 0;
                if(oldVal !== newAct.value) logDetails.push(`‚Ä¢ ${newAct.name}: ${oldVal} -> ${newAct.value}`);
            });

            // 3. Check Deploys (Detailed per field)
            document.querySelectorAll('.deploy-card').forEach((c, i) => {
                const d = {
                    from: c.querySelector('.from-val').value,
                    id: c.querySelector('.id-val').value,
                    batch: c.querySelector('.batch-val').value,
                    rules: c.querySelector('.rules-val').value,
                    ips: c.querySelector('.ips-val').value
                };
                deploys.push(d);

                const oldD = (oldCloudData.deploys && oldCloudData.deploys[i]) ? oldCloudData.deploys[i] : null;
                if(!oldD) {
                    logDetails.push(`‚Ä¢ Deploy ${i+1}: Added New`);
                } else {
                    let changes = [];
                    if(oldD.from !== d.from) changes.push(`From(${d.from})`);
                    if(oldD.id !== d.id) changes.push(`ID(${d.id})`);
                    if(oldD.batch !== d.batch) changes.push(`Batch(${d.batch})`);
                    if(oldD.ips !== d.ips) changes.push(`IPs Updated`);
                    if(changes.length > 0) logDetails.push(`‚Ä¢ Deploy ${i+1}: ${changes.join(', ')}`);
                }
            });

            const finalLog = logDetails.length > 0 ? logDetails.join('\n') : "General Update";
            const saveObj = { deploys, filter, limit, actions_list: actions, timestamp };

            document.getElementById('loadingOverlay').style.display = 'flex';
            await db.ref(`ems4/plans/${currentPlatform}/current`).set(saveObj);
            await db.ref(`ems4/plans/${currentPlatform}/history`).push({ timestamp, changeSummary: finalLog });

            const viewerLink = `${netlifyBase}/?mode=view&plat=${currentPlatform}`;
            const telegramMsg = `üöÄ <b>UPDATE [#${currentPlatform}]</b>\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n` +
                                `üéØ <b>Filter:</b> ${filter || 'N/A'}\n` +
                                `üïí <b>Time:</b> ${timestamp}\n\n` +
                                `üìù <b>Changes:</b>\n${finalLog}\n` +
                                `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n` +
                                `üîó <a href="${viewerLink}">CLICK HERE TO OPEN VIEW</a>`;

            await fetch(`https://api.telegram.org/bot${telegramToken}/sendMessage`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ chat_id: telegramChatId, text: telegramMsg, parse_mode: 'HTML' })
            });

            alert("Saved!");
            location.reload();
        }

        function generateDeploys(savedData = null) {
            const num = parseInt(document.getElementById('deployCount').value) || 0;
            const container = document.getElementById('deploysContainer');
            container.innerHTML = "";
            for (let i = 0; i < num; i++) {
                const d = (savedData && savedData[i]) ? savedData[i] : { from: '', id: '', batch: '10/3000P', rules: 'SELECT ALL IPS', ips: '' };
                container.innerHTML += `
                    <div class="deploy-card bg-white p-4 rounded-2xl shadow-sm border border-slate-200">
                        <div class="text-[10px] font-black mb-2 uppercase text-slate-400">Deploy ${i+1}</div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-2">
                            <input type="text" oninput="checkIfChanged()" class="from-val p-2 border rounded text-xs" value="${d.from}" placeholder="FROM">
                            <input type="text" oninput="checkIfChanged()" class="id-val p-2 border rounded text-xs font-black text-blue-600" value="${d.id}" placeholder="ID">
                            <select onchange="checkIfChanged()" class="batch-val p-2 border rounded text-xs">
                                <option ${d.batch == '10/3000P' ? 'selected' : ''}>10/3000P</option>
                                <option ${d.batch == '5/3000P' ? 'selected' : ''}>5/3000P</option>
                            </select>
                            <select onchange="checkIfChanged()" class="rules-val p-2 border rounded text-xs"><option>SELECT ALL IPS</option></select>
                        </div>
                        <textarea oninput="checkIfChanged()" class="ips-val w-full p-2 border rounded text-[10px] font-mono bg-slate-50" rows="1" placeholder="IPs">${d.ips}</textarea>
                    </div>`;
            }
        }
        function changePlat(p, v) { selectPlatform(p, v); }
        function checkIfChanged() { document.getElementById('saveBtn').disabled = false; }
        function showActionMenu(type) {
            const list = document.getElementById('modalList');
            list.innerHTML = "";
            const opts = type === 'spam' ? ["NOT SPAM", "REPLY", "CLICK", "MOVE"] : ["READ", "ARCHIVE", "STAR"];
            opts.forEach(o => {
                const b = document.createElement('button');
                b.className = "p-3 text-left hover:bg-slate-100 uppercase text-[10px] font-bold";
                b.innerText = o;
                b.onclick = () => { addActionUI(type, o, 0); closeModal(); checkIfChanged(); };
                list.appendChild(b);
            });
            document.getElementById('actionModal').classList.remove('hidden');
        }
        function closeModal() { document.getElementById('actionModal').classList.add('hidden'); }
        function updateLimitUI() { generateDeploys(null); }
    </script>
</body>
</html>
